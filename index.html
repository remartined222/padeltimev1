<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padel Time v.1</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Fondo gris claro */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .app-container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* Esquinas más redondeadas */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2.5rem; /* Mayor espaciado interno */
            max-width: 500px;
            width: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            /* Centrar el contenedor en pantallas más grandes */
            margin-left: auto;
            margin-right: auto;
        }
        .screen {
            display: none; /* Oculto por defecto */
            flex-direction: column;
            gap: 1.5rem;
        }
        .screen.active {
            display: flex; /* Mostrar cuando está activo */
        }
        .btn {
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 0.75rem; /* Esquinas redondeadas para botones */
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn:hover {
            background-color: #4338ca; /* Indigo 700 */
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: #ef4444; /* Rojo 500 para Salir */
        }
        .btn-secondary:hover {
            background-color: #dc2626; /* Rojo 600 */
        }
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #d1d5db; /* Gris 300 */
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            box-sizing: border-box; /* Asegura que el padding no aumente el ancho */
        }
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #6366f1; /* Indigo 500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        h1 {
            font-size: 2.5rem; /* Título más grande */
            font-weight: 700;
            color: #1f2937; /* Texto más oscuro */
            margin-bottom: 1.5rem;
        }
        h2 {
            font-size: 1.75rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
        }
        .team-display, .match-scoreboard {
            background-color: #f9fafb; /* Fondo más claro para la visualización de equipos */
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: left;
            margin-top: 1.5rem;
            max-height: 300px; /* Limitar altura para desplazamiento */
            overflow-y: auto; /* Habilitar desplazamiento */
        }
        /* Styles for team display in tournament setup */
        .match-card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .match-line {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        .team-name-display {
            background-color: #e0e7ff; /* Light indigo background */
            border: 1px solid #a5b4fc; /* Indigo 300 */
            border-radius: 0.5rem;
            padding: 0.4rem 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: #3730a3; /* Indigo 800 */
        }
        .vs-text-display {
            font-weight: 700;
            color: #4b5563;
        }

        .error-message {
            color: #ef4444; /* Rojo 500 */
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        .modal {
            display: none; /* Oculto por defecto */
            position: fixed; /* Permanece en su lugar */
            z-index: 1000; /* Se superpone a todo */
            left: 0;
            top: 0;
            width: 100%; /* Ancho completo */
            height: 100%; /* Alto completo */
            overflow: auto; /* Habilitar desplazamiento si es necesario */
            background-color: rgba(0,0,0,0.4); /* Negro con opacidad */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .score-display {
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-size: 2.5rem; /* Números de puntuación grandes */
            font-weight: 700;
            color: #1f2937;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
        }
        .score-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1; /* Distribuir espacio equitativamente */
        }
        .score-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #6b7280; /* Gris 500 */
            margin-bottom: 0.5rem;
        }
        .score-buttons {
            display: flex;
            justify-content: space-around;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .score-btn {
            background-color: #10b981; /* Esmeralda 500 */
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .score-btn:hover {
            background-color: #059669; /* Esmeralda 600 */
            transform: translateY(-2px);
        }
        .match-teams {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
            /* Flexbox responsivo para los equipos en la pantalla de partido */
            display: flex;
            flex-direction: column; /* Por defecto, apilar en móviles */
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* Espacio más pequeño en móvil */
        }
        /* Media query para pantallas más grandes (sm breakpoint de Tailwind) */
        @media (min-width: 640px) {
            .match-teams {
                flex-direction: row; /* En pantallas grandes, poner en fila */
                gap: 1rem; /* Restaurar espacio normal */
            }
        }

        .match-teams .team-name-box-container { /* Contenedor para etiqueta y nombre */
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%; /* Ocupar todo el ancho disponible en móvil */
        }
        @media (min-width: 640px) {
            .match-teams .team-name-box-container {
                width: auto; /* Ancho automático en pantallas grandes */
                flex-grow: 1; /* Permitir que crezca */
            }
        }

        .match-teams .team-number-label { /* Estilo para el número pequeño del equipo */
            font-size: 0.75rem; /* Tamaño de fuente más pequeño */
            font-weight: 500;
            color: #6b7280; /* Texto gris */
            margin-bottom: 0.25rem; /* Pequeño espacio debajo de la etiqueta */
        }
        .match-teams .team-name-display {
            flex-grow: 1; /* Permitir que crezca */
            justify-content: center; /* Centrar contenido dentro del cuadro */
            padding: 0.75rem 1rem; /* Espaciado ligeramente más grande */
            font-size: 0.9rem; /* Ajustar tamaño de fuente para legibilidad en móvil */
        }
        @media (min-width: 640px) {
            .match-teams .team-name-display {
                font-size: 1rem; /* Tamaño de fuente normal en pantallas grandes */
            }
        }

        .tournament-progress {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: left;
            margin-top: 1.5rem;
            max-height: 200px;
            overflow-y: auto;
        }
        /* Styles for match summary items */
        .match-summary-item {
            display: flex;
            flex-direction: column; /* Apilar en móvil */
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            gap: 0.5rem; /* Espacio entre elementos */
        }
        @media (min-width: 640px) {
            .match-summary-item {
                flex-direction: row; /* En pantallas grandes, poner en fila */
                gap: 1rem; /* Espacio normal */
            }
        }

        .match-teams-summary {
            display: flex;
            flex-direction: column; /* Apilar en móvil */
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            flex-grow: 1; /* Permitir que crezca */
            width: 100%; /* Ocupar todo el ancho en móvil */
        }
        @media (min-width: 640px) {
            .match-teams-summary {
                flex-direction: row; /* En pantallas grandes, poner en fila */
                width: auto; /* Ancho automático */
            }
        }

        .team-box-summary, .winner-box-summary {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            background-color: #f3f4f6;
            font-size: 0.85rem;
            font-weight: 500;
            text-align: center;
            white-space: nowrap; /* Evitar saltos de línea en nombres */
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1; /* Permitir que crezca */
            width: 100%; /* Ocupar todo el ancho en móvil */
        }
        @media (min-width: 640px) {
            .team-box-summary, .winner-box-summary {
                width: auto; /* Ancho automático en pantallas grandes */
            }
        }

        .winner-box-summary {
            background-color: #d1fae5; /* Verde claro para ganador */
            border-color: #34d399; /* Borde verde */
            font-weight: 600;
        }
        .winner-box-champion { /* Nuevo estilo para campeón */
            background-color: #ffeb3b; /* Amarillo para campeón */
            border-color: #fbc02d; /* Borde amarillo más oscuro */
            font-weight: 700;
            color: #e65100; /* Texto naranja oscuro */
            box-shadow: 0 4px 8px rgba(255, 235, 59, 0.4);
        }
        .vs-text {
            font-weight: 600;
            color: #4b5563;
        }
        .winner-arrow {
            font-size: 1.5rem;
            color: #4f46e5;
            margin: 0 0.5rem;
        }
        .pending-winner {
            background-color: #e5e7eb; /* Gris para pendiente */
            border-color: #9ca3af;
            color: #6b7280;
        }
        .match-summary-item.pending .team-box-summary {
            background-color: #e5e7eb;
            border-color: #9ca3af;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Splash Screen -->
        <div id="splashScreen" class="screen active">
            <h1>Padel Time v.1</h1>
            <button id="startButton" class="btn">Iniciar</button>
        </div>

        <!-- Mode Selection Screen -->
        <div id="modeSelectionScreen" class="screen">
            <h2>Selecciona una modalidad</h2>
            <button id="tournamentButton" class="btn">Torneo</button>
            <button id="gamesWonButton" class="btn">Juegos ganados</button>
            <button id="exitButton" class="btn btn-secondary">Salir</button>
        </div>

        <!-- Player Input Screen -->
        <div id="playerInputScreen" class="screen">
            <h2>Ingresa los detalles</h2>
            <div>
                <label for="playerNames" class="block text-left text-gray-700 text-sm font-bold mb-2">Nombres de los jugadores (uno por línea):</label>
                <textarea id="playerNames" rows="6" placeholder="Ejemplo:&#10;Edwin&#10;Toño&#10;Rafa&#10;Cristian" class="mb-4"></textarea>
                <p id="playerCount" class="text-gray-600 text-sm text-left mb-2">Jugadores ingresados: 0</p>
                <p id="playerInputError" class="error-message text-left"></p>
            </div>
            <button id="generateTeamsButton" class="btn">Generar Duplas</button>
            <button id="backToModesButton" class="btn btn-secondary">Volver</button>
        </div>

        <!-- Tournament Display Screen -->
        <div id="tournamentDisplayScreen" class="screen">
            <h2>Duplas del Torneo</h2>
            <div id="teamDisplay" class="team-display">
                <!-- Las duplas se insertarán aquí -->
            </div>
            <button id="startTournamentButton" class="btn">Iniciar Torneo</button>
            <button id="backToPlayerInputButton" class="btn btn-secondary">Volver</button>
        </div>

        <!-- Match Screen -->
        <div id="matchScreen" class="screen">
            <h2 id="matchTitle"></h2>
            <div class="match-scoreboard">
                <p class="text-lg font-semibold mb-2">Sets de juego:</p>
                <select id="setsToPlay" class="mb-4">
                    <option value="1">1 Set</option>
                    <option value="3" selected>3 Sets</option>
                    <option value="5">5 Sets</option>
                </select>
                <button id="startMatchButton" class="btn mb-4">Iniciar Juego</button>

                <div class="match-teams">
                    <!-- Contenedor para Equipo 1: número y nombre -->
                    <div class="team-name-box-container">
                        <span class="team-number-label" id="team1NumberLabel"></span>
                        <div id="team1NameDisplay" class="team-name-display">
                            <!-- El contenido se llenará con JS -->
                        </div>
                    </div>
                    <span>vs</span>
                    <!-- Contenedor para Equipo 2: número y nombre -->
                    <div class="team-name-box-container">
                        <span class="team-number-label" id="team2NumberLabel"></span>
                        <div id="team2NameDisplay" class="team-name-display">
                            <!-- El contenido se llenará con JS -->
                        </div>
                    </div>
                </div>

                <div class="score-display">
                    <div class="score-item">
                        <span class="score-label">Puntos</span>
                        <span id="scoreTeam1Points">0</span>
                    </div>
                    <div class="score-item">
                        <span class="score-label">Sets</span>
                        <span id="scoreTeam1Sets">0</span>
                    </div>
                    <span class="text-5xl mx-4">-</span>
                    <div class="score-item">
                        <span class="score-label">Puntos</span>
                        <span id="scoreTeam2Points">0</span>
                    </div>
                    <div class="score-item">
                        <span class="score-label">Sets</span>
                        <span id="scoreTeam2Sets">0</span>
                    </div>
                </div>

                <div class="score-buttons">
                    <button id="addPointTeam1" class="score-btn">Punto</button>
                    <button id="addPointTeam2" class="score-btn">Punto</button>
                </div>
            </div>
            <!-- Botones en la parte inferior de la pantalla de partido -->
            <button id="resetScoreButton" class="btn btn-secondary mt-4">Resetear Puntaje</button>
            <button id="viewTournamentSummaryButton" class="btn mt-2">Ver Resumen del Torneo</button>
            <button id="backToTournamentDisplayButton" class="btn btn-secondary mt-2">Volver a Duplas</button>
        </div>

        <!-- Tournament Progress Screen (New) -->
        <div id="tournamentProgressScreen" class="screen">
            <h2>Progreso del Torneo</h2>
            <div id="tournamentMatchesSummary" class="tournament-progress">
                <!-- Resumen de partidos jugados y ganadores -->
            </div>
            <button id="returnToMatchButton" class="btn mt-4">Volver a Marcadores</button>
            <button id="startNextRoundButton" class="btn mt-2">Siguiente Ronda</button>
            <button id="backToMainFromProgress" class="btn btn-secondary mt-2">Volver al Inicio</button>
        </div>

        <!-- Custom Modal for messages -->
        <div id="customModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeModalButton">&times;</span>
                <p id="modalMessage"></p>
                <button id="modalOkButton" class="btn mt-4">OK</button>
            </div>
        </div>

    </div>

    <script>
        // Obtener referencias a elementos del DOM
        const splashScreen = document.getElementById('splashScreen');
        const modeSelectionScreen = document.getElementById('modeSelectionScreen');
        const playerInputScreen = document.getElementById('playerInputScreen');
        const tournamentDisplayScreen = document.getElementById('tournamentDisplayScreen');
        const matchScreen = document.getElementById('matchScreen'); 
        const tournamentProgressScreen = document.getElementById('tournamentProgressScreen'); 

        const startButton = document.getElementById('startButton');
        const tournamentButton = document.getElementById('tournamentButton');
        const gamesWonButton = document.getElementById('gamesWonButton');
        const exitButton = document.getElementById('exitButton');
        const generateTeamsButton = document.getElementById('generateTeamsButton');
        const backToModesButton = document.getElementById('backToModesButton');
        const backToPlayerInputButton = document.getElementById('backToPlayerInputButton');
        const startTournamentButton = document.getElementById('startTournamentButton');
        const startMatchButton = document.getElementById('startMatchButton'); 
        const backToTournamentDisplayButton = document.getElementById('backToTournamentDisplayButton'); 
        const startNextRoundButton = document.getElementById('startNextRoundButton'); 
        const backToMainFromProgress = document.getElementById('backToMainFromProgress'); 
        const viewTournamentSummaryButton = document.getElementById('viewTournamentSummaryButton'); 
        const returnToMatchButton = document.getElementById('returnToMatchButton'); 

        const playerNamesTextarea = document.getElementById('playerNames');
        const playerCountDisplay = document.getElementById('playerCount');
        const playerInputError = document.getElementById('playerInputError');
        const teamDisplay = document.getElementById('teamDisplay');
        const tournamentMatchesSummary = document.getElementById('tournamentMatchesSummary'); 

        const matchTitle = document.getElementById('matchTitle');
        const setsToPlaySelect = document.getElementById('setsToPlay'); 
        
        // Referencias a los nuevos elementos para mostrar nombre y número de equipo
        const team1NumberLabel = document.getElementById('team1NumberLabel');
        const team1NameDisplay = document.getElementById('team1NameDisplay');
        const team2NumberLabel = document.getElementById('team2NumberLabel');
        const team2NameDisplay = document.getElementById('team2NameDisplay');

        const scoreTeam1Points = document.getElementById('scoreTeam1Points');
        const scoreTeam1Sets = document.getElementById('scoreTeam1Sets');
        const scoreTeam2Points = document.getElementById('scoreTeam2Points');
        const scoreTeam2Sets = document.getElementById('scoreTeam2Sets');
        const addPointTeam1Btn = document.getElementById('addPointTeam1');
        const addPointTeam2Btn = document.getElementById('addPointTeam2'); 
        const resetScoreButton = document.getElementById('resetScoreButton'); 


        const customModal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const closeModalButton = document.getElementById('closeModalButton');
        const modalOkButton = document.getElementById('modalOkButton');

        let currentMode = ''; 
        let allDuplas = []; 
        let tournamentRounds = []; // Stores arrays of matches for each round
        let currentRoundIndex = 0; // Index of the current round being played
        let currentMatchIndex = 0; // Index of the current match within the current round

        let currentMatch = {
            team1: null,
            team2: null,
            score: {
                points: [0, 0], 
                sets: [0, 0]    
            },
            setsRequired: 3, 
            winner: null, 
            isCompleted: false 
        };

        // Mapeo para mostrar los puntos de pádel (0, 15, 30, 40)
        const padelPoints = [0, 15, 30, 40]; 

        // Función para mostrar una pantalla específica y ocultar las demás
        function showScreen(screenId) {
            const screens = [splashScreen, modeSelectionScreen, playerInputScreen, tournamentDisplayScreen, matchScreen, tournamentProgressScreen];
            screens.forEach(screen => {
                if (screen.id === screenId) {
                    screen.classList.add('active');
                } else {
                    screen.classList.remove('active');
                }
            });
        }

        // Función para mostrar el modal personalizado con un mensaje
        function showModal(message) {
            modalMessage.textContent = message;
            customModal.style.display = 'flex';
        }

        // Función para ocultar el modal personalizado
        function hideModal() {
            customModal.style.display = 'none';
        }

        // Función para actualizar la visualización del marcador
        function updateScoreboard() {
            scoreTeam1Points.textContent = padelPoints[currentMatch.score.points[0]];
            scoreTeam2Points.textContent = padelPoints[currentMatch.score.points[1]];
            scoreTeam1Sets.textContent = currentMatch.score.sets[0];
            scoreTeam2Sets.textContent = currentMatch.score.sets[1];
        }

        // Función para manejar la adición de un punto a un equipo (Lógica de Pádel simplificada)
        function addPoint(teamIndex) {
            if (currentMatch.isCompleted) {
                showModal('El partido ha terminado. Por favor, inicia el siguiente partido o resetea el puntaje.');
                return;
            }

            // Incrementar el contador de puntos interno (0, 1, 2, 3)
            currentMatch.score.points[teamIndex]++;

            // Si el equipo alcanza 4 puntos (equivalente a ganar el set en esta lógica simplificada)
            if (currentMatch.score.points[teamIndex] >= 4) {
                winSet(teamIndex);
            }
            updateScoreboard();
        }

        // Función para manejar la victoria de un set
        function winSet(teamIndex) {
            currentMatch.score.sets[teamIndex]++;
            const winnerTeamName = teamIndex === 0 ?
                `${currentMatch.team1[0]} + ${currentMatch.team1[1]}` :
                `${currentMatch.team2[0]} + ${currentMatch.team2[1]}`;
            showModal(`${winnerTeamName} (Equipo ${teamIndex + 1}) gana el set!`);
            
            // Reiniciar los puntos para ambos equipos para el nuevo set
            currentMatch.score.points = [0, 0]; 
            updateScoreboard(); 
            
            checkMatchWin(teamIndex);
        }

        // Función para verificar si se gana el partido
        function checkMatchWin(winningTeamIndex) {
            const setsNeededToWin = Math.ceil(currentMatch.setsRequired / 2);
            if (currentMatch.score.sets[winningTeamIndex] >= setsNeededToWin) {
                const winnerTeam = winningTeamIndex === 0 ? currentMatch.team1 : currentMatch.team2;
                const loserTeam = winningTeamIndex === 0 ? currentMatch.team2 : currentMatch.team1; // Get the losing team
                const winnerTeamName = `${winnerTeam[0]} + ${winnerTeam[1]}`;
                showModal(`¡El partido ha terminado! ${winnerTeamName} (Equipo ${winningTeamIndex + 1}) gana el partido!`);
                
                // Actualizar el partido en la lista de torneos con el ganador y la puntuación final
                tournamentRounds[currentRoundIndex][currentMatchIndex].winner = winnerTeam;
                tournamentRounds[currentRoundIndex][currentMatchIndex].status = 'completed';
                tournamentRounds[currentRoundIndex][currentMatchIndex].finalScore = [...currentMatch.score.sets]; // Store a copy of sets
                currentMatch.isCompleted = true; // Marcar el partido actual como completado

                addPointTeam1Btn.disabled = true; // Deshabilitar botones de puntuación
                addPointTeam2Btn.disabled = true;
                
                // Cambiar el texto del botón "Iniciar Juego" a "Siguiente Partido"
                startMatchButton.textContent = 'Siguiente Partido';
                startMatchButton.disabled = false; // Habilitar el botón para el siguiente partido
                
                updateTournamentSummary(); // Actualizar el resumen del torneo
            }
        }

        // Función para reiniciar todos los puntajes del partido actual
        function resetAllScores() {
            currentMatch.score = {
                points: [0, 0],
                sets: [0, 0]
            };
            currentMatch.isCompleted = false; // El partido ya no está completado
            updateScoreboard();
            addPointTeam1Btn.disabled = false; // Habilitar botones de puntuación
            addPointTeam2Btn.disabled = false;
            startMatchButton.textContent = 'Iniciar Juego'; // Resetear texto del botón
            startMatchButton.disabled = false; // Asegurarse de que el botón de inicio esté habilitado
            showModal('Puntaje reseteado.');
        }

        // Función para generar los partidos de la primera ronda del torneo
        function generateFirstRoundMatches(duplas) {
            tournamentRounds = []; // Reiniciar todas las rondas
            const firstRoundMatches = [];
            for (let i = 0; i < duplas.length; i += 2) {
                if (duplas[i + 1]) { // Asegurarse de que haya un segundo equipo
                    firstRoundMatches.push({
                        team1: duplas[i],
                        team2: duplas[i + 1],
                        winner: null,
                        status: 'pending',
                        finalScore: null // Store final score of sets [team1_sets, team2_sets]
                    });
                } else {
                    // Handle bye
                    firstRoundMatches.push({
                        team1: duplas[i],
                        team2: null, // Indicates a bye
                        winner: duplas[i], // Team with bye automatically wins this "match"
                        status: 'completed',
                        finalScore: [1, 0] // A bye is like winning 1-0 in sets
                    });
                    showModal(`Advertencia: Hay un número impar de duplas. ${duplas[i][0]} + ${duplas[i][1]} tiene un "bye" en esta ronda.`);
                }
            }
            tournamentRounds.push(firstRoundMatches); // Add the first round
            currentRoundIndex = 0; // Start at the first round
            currentMatchIndex = -1; // Prepare for loadNextMatch
        }

        // Función para cargar el siguiente partido
        function loadNextMatch() {
            currentMatchIndex++;
            // Check if there are more matches in the current round
            if (currentMatchIndex < tournamentRounds[currentRoundIndex].length) {
                const nextMatch = tournamentRounds[currentRoundIndex][currentMatchIndex];

                // If this match is already completed (e.g., a bye), skip to the next one
                if (nextMatch.status === 'completed') {
                    loadNextMatch();
                    return;
                }

                currentMatch.team1 = nextMatch.team1;
                currentMatch.team2 = nextMatch.team2;
                currentMatch.isCompleted = false; // Reset state for the new match
                currentMatch.winner = null; // Reset winner for the new match

                matchTitle.textContent = `Partido: ${currentMatch.team1[0]} + ${currentMatch.team1[1]} vs ${currentMatch.team2 ? currentMatch.team2[0] + ' + ' + currentMatch.team2[1] : 'BYE'}`;
                
                team1NumberLabel.textContent = `Equipo 1`;
                team1NameDisplay.innerHTML = `🎾 ${currentMatch.team1[0]} + ${currentMatch.team1[1]}`;
                
                team2NumberLabel.textContent = `Equipo 2`;
                team2NameDisplay.innerHTML = currentMatch.team2 ? `🎾 ${currentMatch.team2[0]} + ${currentMatch.team2[1]}` : 'BYE';

                resetAllScores(); // Reset the scoreboard for the new match
                startMatchButton.textContent = 'Iniciar Juego'; // Reset button text
                startMatchButton.disabled = false; // Enable start button

                showModal(`Siguiente partido: ${currentMatch.team1[0]} + ${currentMatch.team1[1]} vs ${currentMatch.team2[0]} + ${currentMatch.team2[1]}`);

            } else {
                // All matches in the current round have been played
                showModal('¡Todos los partidos de esta ronda han sido jugados! Puedes ver el progreso del torneo y generar la siguiente ronda.');
                startMatchButton.disabled = true;
                startMatchButton.textContent = 'Ronda Finalizada';
                showScreen('tournamentProgressScreen'); // Go to tournament progress screen
                updateTournamentSummary(); // Ensure summary is updated
                startNextRoundButton.disabled = false; // Enable the "Siguiente Ronda" button
            }
        }

        // Función para actualizar el resumen de partidos del torneo
        function updateTournamentSummary() {
            tournamentMatchesSummary.innerHTML = ''; // Limpiar contenido previo
            tournamentRounds.forEach((roundMatches, roundNum) => {
                tournamentMatchesSummary.innerHTML += `<h3 class="text-lg font-semibold mb-2">Ronda ${roundNum + 1}:</h3>`;
                roundMatches.forEach((match, index) => {
                    const team1Display = `${match.team1[0]} + ${match.team1[1]}`;
                    const team2Display = match.team2 ? `${match.team2[0]} + ${match.team2[1]}` : 'BYE';
                    let winnerDisplay = '';
                    let matchItemClass = 'match-summary-item';
                    let winnerBoxClass = 'winner-box-summary';
                    let winnerEmoji = '🏆'; // Default winner emoji

                    if (match.status === 'completed') {
                        winnerDisplay = `${match.winner[0]} + ${match.winner[1]}`;
                        // Check if it's the final round and this is the last match
                        if (roundNum === tournamentRounds.length - 1 && roundMatches.length === 1) { // Final round has only one match
                            winnerEmoji = '🏆👑'; // Champion emojis
                            winnerBoxClass += ' winner-box-champion'; // Apply champion specific style
                        }
                    } else {
                        winnerDisplay = 'Pendiente';
                        matchItemClass += ' pending';
                        winnerBoxClass += ' pending-winner';
                    }

                    tournamentMatchesSummary.innerHTML += `
                        <div class="${matchItemClass}">
                            <div class="match-teams-summary">
                                <div class="team-box-summary">🎾 ${team1Display}</div>
                                <span class="vs-text">vs</span>
                                <div class="team-box-summary">🎾 ${team2Display}</div>
                            </div>
                            <div class="winner-arrow">→</div>
                            <div class="${winnerBoxClass}">${winnerEmoji} ${winnerDisplay}</div>
                        </div>
                    `;
                });
            });
        }


        // Escuchadores de eventos
        startButton.addEventListener('click', () => {
            showScreen('modeSelectionScreen');
        });

        tournamentButton.addEventListener('click', () => {
            currentMode = 'Torneo';
            showScreen('playerInputScreen');
            playerInputError.textContent = ''; 
            playerNamesTextarea.value = ''; 
            playerCountDisplay.textContent = 'Jugadores ingresados: 0';
        });

        gamesWonButton.addEventListener('click', () => {
            currentMode = 'Juegos ganados';
            showModal('La modalidad "Juegos ganados" aún no está implementada. Por favor, selecciona "Torneo".');
        });

        exitButton.addEventListener('click', () => {
            showModal('Gracias por usar Padel Time. ¡Hasta pronto!');
        });

        backToModesButton.addEventListener('click', () => {
            showScreen('modeSelectionScreen');
        });

        backToPlayerInputButton.addEventListener('click', () => {
            showScreen('playerInputScreen');
        });

        backToTournamentDisplayButton.addEventListener('click', () => {
            showScreen('tournamentDisplayScreen');
            addPointTeam1Btn.disabled = false; 
            addPointTeam2Btn.disabled = false;
        });

        viewTournamentSummaryButton.addEventListener('click', () => { 
            updateTournamentSummary();
            showScreen('tournamentProgressScreen');
        });

        returnToMatchButton.addEventListener('click', () => { 
            showScreen('matchScreen');
        });

        playerNamesTextarea.addEventListener('input', () => {
            const players = playerNamesTextarea.value.split('\n').filter(name => name.trim() !== '');
            playerCountDisplay.textContent = `Jugadores ingresados: ${players.length}`;
            playerInputError.textContent = ''; 
        });

        generateTeamsButton.addEventListener('click', () => {
            const players = playerNamesTextarea.value.split('\n').map(name => name.trim()).filter(name => name !== '');

            playerInputError.textContent = ''; 

            if (players.length < 4) {
                playerInputError.textContent = 'Necesitas al menos 4 jugadores para formar duplas.';
                return;
            }
            if (players.length % 2 !== 0) {
                playerInputError.textContent = 'El número de jugadores debe ser par para formar duplas.';
                return;
            }

            // Mezclar jugadores aleatoriamente
            for (let i = players.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [players[i], players[j]] = [players[j], players[i]];
            }

            // Formar todas las duplas posibles a partir de los jugadores mezclados
            allDuplas = []; 
            for (let i = 0; i < players.length; i += 2) {
                allDuplas.push([players[i], players[i + 1]]);
            }

            displayTournamentDuplas(allDuplas);
            showScreen('tournamentDisplayScreen');
        });

        startTournamentButton.addEventListener('click', () => {
            if (allDuplas.length < 2) {
                showModal('Necesitas al menos 2 duplas para iniciar un partido de torneo.');
                return;
            }
            
            generateFirstRoundMatches(allDuplas); 
            currentMatchIndex = -1; // Reiniciar para que loadNextMatch cargue el primer partido
            loadNextMatch(); 
            
            showScreen('matchScreen');
        });

        startMatchButton.addEventListener('click', () => {
            if (currentMatch.isCompleted) { 
                loadNextMatch();
            } else { 
                currentMatch.setsRequired = parseInt(setsToPlaySelect.value, 10);
                showModal(`¡El juego ha iniciado! Se jugarán al mejor de ${currentMatch.setsRequired} sets.`);
                currentMatch.score = {
                    points: [0, 0],
                    sets: [0, 0]
                };
                updateScoreboard();
                addPointTeam1Btn.disabled = false; 
                addPointTeam2Btn.disabled = false;
                startMatchButton.disabled = true; 
            }
        });

        addPointTeam1Btn.addEventListener('click', () => addPoint(0));
        addPointTeam2Btn.addEventListener('click', () => addPoint(1));
        resetScoreButton.addEventListener('click', resetAllScores); 
        startNextRoundButton.addEventListener('click', () => {
            // Disable the button immediately to prevent multiple clicks
            startNextRoundButton.disabled = true;

            // 1. Get Winners and Losers from the current round
            const currentRoundMatches = tournamentRounds[currentRoundIndex];
            const roundWinners = [];
            const roundLosers = []; // Store objects: { team: [player1, player2], setsLost: number }

            currentRoundMatches.forEach(match => {
                if (match.status === 'completed') {
                    roundWinners.push(match.winner);
                    // Identify the loser and their sets won (if not a bye)
                    if (match.team2 !== null) { // Not a bye
                        const loserIndex = (match.winner === match.team1) ? 1 : 0;
                        const losingTeam = (loserIndex === 0) ? match.team1 : match.team2;
                        const setsWonByLoser = match.finalScore[loserIndex];
                        roundLosers.push({ team: losingTeam, setsWon: setsWonByLoser });
                    }
                }
            });

            // Handle the end of the tournament
            if (roundWinners.length === 1) {
                showModal(`¡El torneo ha terminado! El campeón es: ${roundWinners[0][0]} + ${roundWinners[0][1]}`);
                updateTournamentSummary(); // Update to show champion emoji
                return; // End of tournament
            }

            let nextRoundParticipants = [...roundWinners];

            // 2. Handle "lucky loser" scenario if needed (e.g., 3 winners for a 4-team semifinal)
            if (roundWinners.length === 3) {
                if (roundLosers.length > 0) {
                    // Sort losers by sets won (descending), then pick the first one
                    roundLosers.sort((a, b) => b.setsWon - a.setsWon);
                    const luckyLoser = roundLosers[0].team;
                    nextRoundParticipants.push(luckyLoser);
                    showModal(`¡Un equipo perdedor avanza! El equipo de "lucky loser" es: ${luckyLoser[0]} + ${luckyLoser[1]}`);
                } else {
                    showModal('Advertencia: No hay perdedores disponibles para un "lucky loser". Se necesitará un "bye".');
                    // If no losers, a bye will be implicitly handled in pairing
                }
            }

            // Shuffle participants for new pairings
            for (let i = nextRoundParticipants.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [nextRoundParticipants[i], nextRoundParticipants[j]] = [nextRoundParticipants[j], nextRoundParticipants[i]];
            }

            // 3. Generate new matches for the next round
            const newRoundMatches = [];
            for (let i = 0; i < nextRoundParticipants.length; i += 2) {
                if (nextRoundParticipants[i + 1]) {
                    newRoundMatches.push({
                        team1: nextRoundParticipants[i],
                        team2: nextRoundParticipants[i + 1],
                        winner: null,
                        status: 'pending',
                        finalScore: null
                    });
                } else {
                    // Handle bye for the new round
                    newRoundMatches.push({
                        team1: nextRoundParticipants[i],
                        team2: null,
                        winner: nextRoundParticipants[i],
                        status: 'completed',
                        finalScore: [1, 0]
                    });
                    showModal(`Advertencia: Un equipo (${nextRoundParticipants[i][0]} + ${nextRoundParticipants[i][1]}) avanza por "bye" en la siguiente ronda.`);
                }
            }

            if (newRoundMatches.length === 0) {
                showModal('No se pudieron generar partidos para la siguiente ronda. El torneo puede haber terminado o no hay suficientes equipos.');
                return;
            }

            // 4. Update Tournament State
            tournamentRounds.push(newRoundMatches); // Add the new round
            currentRoundIndex++; // Move to the next round
            currentMatchIndex = -1; // Prepare to load the first match of the new round

            showModal(`¡Comienza la Ronda ${currentRoundIndex + 1}!`);
            loadNextMatch(); // Load the first match of the new round
            showScreen('matchScreen'); // Go back to the match screen
        });
        backToMainFromProgress.addEventListener('click', () => {
            showScreen('modeSelectionScreen');
        });


        closeModalButton.addEventListener('click', hideModal);
        modalOkButton.addEventListener('click', hideModal);
        window.addEventListener('click', (event) => {
            if (event.target == customModal) {
                hideModal();
            }
        });

        // Función para mostrar todas las duplas formadas para el modo torneo
        function displayTournamentDuplas(duplas) {
            teamDisplay.innerHTML = ''; 

            if (duplas.length === 0) {
                teamDisplay.innerHTML = '<p class="text-gray-500">No se pudieron formar duplas con los jugadores ingresados.</p>';
                return;
            }

            // Crear emparejamientos (ej. Equipo 1 vs Equipo 2)
            for (let i = 0; i < duplas.length; i += 2) {
                const team1 = duplas[i];
                const team2 = duplas[i + 1]; 

                const matchCardDiv = document.createElement('div');
                matchCardDiv.classList.add('match-card');

                if (team2) { 
                    matchCardDiv.innerHTML = `
                        <div class="match-line">
                            <div class="team-name-display">🎾 Equipo ${i / 2 + 1}: ${team1[0]} + ${team1[1]}</div>
                        </div>
                        <div class="match-line">
                            <span class="vs-text-display">VS</span>
                        </div>
                        <div class="match-line">
                            <div class="team-name-display">🎾 Equipo ${i / 2 + 2}: ${team2[0]} + ${team2[1]}</div>
                        </div>
                    `;
                } else { 
                    matchCardDiv.innerHTML = `
                        <div class="match-line">
                            <div class="team-name-display">🎾 Equipo ${i / 2 + 1}: ${team1[0]} + ${team1[1]}</div>
                        </div>
                        <div class="match-line">
                            <span class="vs-text-display">BYE</span>
                        </div>
                        <div class="match-line">
                            <div class="team-name-display pending-winner">Esperando oponente...</div>
                        </div>
                    `;
                }
                teamDisplay.appendChild(matchCardDiv);
            }
        }

        // Configuración inicial de la pantalla
        showScreen('splashScreen');
    </script>
</body>
</html>
