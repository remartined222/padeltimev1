<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padel Time v.1</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://images.pexels.com/photos/8485104/pexels-photo-8485104.jpeg?auto=compress&cs=tinysrgb&dpr=2&h=650&w=940'); /* Fondo para toda la app */
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
            position: relative; /* Para el pseudo-elemento */
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4); /* Capa oscura semitransparente */
            z-index: -1; /* Detrás de todo el contenido */
        }

        .app-container {
            background-color: transparent; /* Fondo transparente para ver la imagen de fondo global */
            border-radius: 1.5rem; /* Esquinas más redondeadas */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            max-width: 500px;
            width: 100%;
            height: 95vh; /* Altura responsiva */
            max-height: 800px; /* Altura máxima */
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-left: auto;
            margin-right: auto;
            overflow: hidden; /* Asegurar que el contenido no se desborde */
            position: relative; /* Para que el z-index funcione correctamente */
            z-index: 1; /* Asegurar que esté por encima del fondo */
        }
        .screen {
            display: none; /* Oculto por defecto */
            flex-direction: column;
            gap: 1rem;
            background-color: rgba(255, 255, 255, 0.9); /* Fondo blanco semitransparente para las pantallas internas */
            border-radius: 1.2rem; /* Mantener bordes redondeados */
            padding: 1.5rem; /* Padding interno para el contenido */
            justify-content: space-between; /* Distribuir contenido y empujar copyright al final */
            height: 100%; /* Ocupar todo el alto del app-container */
            overflow: hidden; /* Ocultar overflow general de la pantalla */
        }
        .screen.active {
            display: flex; /* Mostrar cuando está activo */
        }
        
        /* Contenedor principal del contenido de cada pantalla para permitir scroll */
        .screen > .screen-content {
            flex-grow: 1;
            overflow-y: auto; /* Habilitar scroll si el contenido es muy largo */
            padding-right: 0.5rem; /* Espacio para la barra de scroll */
        }


        /* Estilos específicos para la pantalla de inicio */
        #splashScreen {
            padding: 0;
            border-radius: 1.5rem;
            overflow: hidden;
            justify-content: center;
            align-items: center;
            color: white;
            background-color: transparent;
            z-index: 1;
        }
        #splashScreen.active {
            display: flex;
        }

        #splashScreen .splash-content {
            width: 90%;
            max-width: 380px;
            height: 90%;
            max-height: 550px;
            padding: 2rem;
            background: rgba(0, 0, 0, 0.6);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1;
            border-radius: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            text-align: center;
        }
        
        #splashScreen h1,
        #splashScreen .main-subtitle,
        #splashScreen .subtitle,
        #splashScreen .copyright,
        #splashScreen .btn {
            position: relative;
            z-index: 1;
        }

        #splashScreen h1 {
            font-size: 3.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.2rem;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.7);
        }
        #splashScreen .main-subtitle {
            font-size: 1.3rem;
            font-weight: 500;
            color: white;
            margin-bottom: 0.5rem;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        #splashScreen .subtitle {
            font-size: 0.9rem;
            font-weight: 400;
            color: rgba(255,255,255,0.8);
            margin-bottom: 0.2rem;
        }
        #splashScreen .copyright {
            font-size: 0.75rem;
            font-weight: 300;
            color: rgba(255,255,255,0.6);
            margin-top: 1rem;
        }

        #splashScreen .btn {
            width: 80%;
            max-width: 250px;
            background-color: #ef4444;
        }
        #splashScreen .btn:hover {
            background-color: #dc2626;
        }

        @media (max-width: 380px) {
            #splashScreen h1 {
                font-size: 3rem;
            }
            #splashScreen .main-subtitle {
                font-size: 1.1rem;
            }
        }

        .btn {
            background-color: #2823bc;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn:hover {
            background-color: #1a178c;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: #ef4444;
        }
        .btn-secondary:hover {
            background-color: #dc2626;
        }
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
        }
        h2 {
            font-size: 1.75rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
        }

        #modeSelectionScreen .screen-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
        }
        #modeSelectionScreen h2 {
            font-size: 1.75rem;
            margin-bottom: 2rem;
        }
        .process-text {
            color: #6b7280;
            font-size: 0.8rem;
            margin-top: -1rem;
        }

        .team-display, .match-scoreboard {
            background-color: transparent;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: left;
            margin-top: 1.5rem;
        }
        .match-card {
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .match-line {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        .team-name-display {
            background-color: #e0e7ff;
            border: 1px solid #a5b4fc;
            border-radius: 0.5rem;
            padding: 0.4rem 0.8rem;
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: #3730a3;
        }
        .vs-text-display {
            font-weight: 700;
            color: #4b5563;
        }

        .error-message {
            color: #ef4444;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .score-display {
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-size: 2.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
        }
        .score-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }
        .score-item.points-separator {
            position: relative;
            padding-right: 1.5rem;
            margin-right: 1.5rem;
        }
        .score-item.points-separator::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 2px;
            height: 80%;
            background-color: #6366f1;
            border-radius: 1px;
        }
        .score-item:last-child {
            border-right: none;
            padding-right: 0;
            margin-right: 0;
        }
        .score-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        .score-buttons {
            display: flex;
            justify-content: space-around;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .score-btn {
            background-color: #10b981;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .score-btn:hover {
            background-color: #059669;
            transform: translateY(-2px);
        }
        .match-teams {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        @media (min-width: 640px) {
            .match-teams {
                flex-direction: row;
                gap: 1rem;
            }
        }
        .match-teams .team-name-box-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        @media (min-width: 640px) {
            .match-teams .team-name-box-container {
                width: auto;
                flex-grow: 1;
            }
        }
        .match-teams .team-number-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }
        .match-teams .team-name-display {
            flex-grow: 1;
            justify-content: center;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
        }
        @media (min-width: 640px) {
            .match-teams .team-name-display {
                font-size: 1rem;
            }
        }
        .tournament-progress {
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: left;
            margin-top: 1.5rem;
        }
        .match-summary-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            gap: 0.5rem;
        }
        @media (min-width: 640px) {
            .match-summary-item {
                flex-direction: row;
                gap: 1rem;
            }
        }
        .match-teams-summary {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            flex-grow: 1;
            width: 100%;
        }
        @media (min-width: 640px) {
            .match-teams-summary {
                flex-direction: row;
                width: auto;
            }
        }
        .team-box-summary, .winner-box-summary {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            background-color: #f3f4f6;
            font-size: 0.85rem;
            font-weight: 500;
            text-align: center;
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
            flex-grow: 1;
            width: 100%;
        }
        @media (min-width: 640px) {
            .team-box-summary, .winner-box-summary {
                width: auto;
            }
        }
        .winner-box-summary {
            background-color: #d1fae5;
            border-color: #34d399;
            font-weight: 600;
        }
        .winner-box-champion {
            background-color: #ffeb3b;
            border-color: #fbc02d;
            font-weight: 700;
            color: #e65100;
            box-shadow: 0 4px 8px rgba(255, 235, 59, 0.4);
        }
        .vs-text {
            font-weight: 600;
            color: #4b5563;
        }
        .winner-arrow {
            font-size: 1.5rem;
            color: #4f46e5;
            margin: 0 0.5rem;
        }
        .pending-winner {
            background-color: #e5e7eb;
            border-color: #9ca3af;
            color: #6b7280;
        }
        .match-summary-item.pending .team-box-summary {
            background-color: #e5e7eb;
            border-color: #9ca3af;
            color: #6b7280;
        }
        .copyright-text {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: auto;
            padding-top: 1rem;
            text-align: center;
            flex-shrink: 0; /* Evitar que el copyright se encoja */
        }
    </style>
</head>
<body>
    <div id="mainBackground"></div> <!-- New background layer -->
    <div class="app-container">
        <div id="splashScreen" class="screen active">
            <div class="splash-content">
                <div class="splash-header"> <!-- Contenedor para el contenido superior -->
                    <h1>Padeltime® 🎾</h1>
                    <p class="main-subtitle">Tu mejor compañero en torneos de Pádel</p>
                    <p class="subtitle">v.01</p>
                </div>
                <div class="splash-footer"> <!-- Contenedor para el contenido inferior -->
                    <button id="startButton" class="btn">Iniciar</button>
                    <p class="copyright">Derechos reservados &reg; - EM. 9995.86.68.81.</p>
                </div>
            </div>
        </div>

        <!-- Mode Selection Screen -->
        <div id="modeSelectionScreen" class="screen">
            <div class="screen-content">
                <h2 style="font-size: 1.75rem; margin-bottom: 2rem;">Selecciona una modalidad</h2>
                <button id="tournamentButton" class="btn">Torneo</button>
                <button id="gamesWonButton" class="btn">Juegos ganados *</button>
                <p class="process-text">* En proceso de creación</p>
                <button id="instructionsButton" class="btn">Instrucciones</button> <!-- New Instructions button -->
                <button id="exitButton" class="btn btn-secondary">Salir</button>
            </div>
            <p class="copyright-text">Derechos reservados &reg; - EM. 9995.86.68.81.</p>
        </div>

        <!-- Player Input Screen -->
        <div id="playerInputScreen" class="screen">
            <div class="screen-content">
                <h2>Ingresa los detalles</h2>
                <div>
                    <label for="playerNames" class="block text-left text-gray-700 text-sm font-bold mb-2">Nombres de los jugadores (uno por línea):</label>
                    <textarea id="playerNames" rows="10" placeholder="Ejemplo:&#10;Edwin&#10;Toño&#10;Rafa&#10;Cristian" class="mb-4"></textarea>
                    <p id="playerCount" class="text-gray-600 text-sm text-left mb-2">Jugadores ingresados: 0</p>
                    <p id="playerInputError" class="error-message text-left"></p>
                </div>
                <button id="generateTeamsButton" class="btn">Generar Duplas</button>
                <button id="backToModesButton" class="btn btn-secondary">Volver</button>
            </div>
            <p class="copyright-text">Derechos reservados &reg; - EM. 9995.86.68.81.</p>
        </div>

        <!-- Tournament Display Screen -->
        <div id="tournamentDisplayScreen" class="screen">
            <div class="screen-content">
                <h2>Duplas del Torneo</h2>
                <div id="teamDisplay" class="team-display">
                    <!-- Las duplas se insertarán aquí -->
                </div>
                <button id="startTournamentButton" class="btn">Iniciar Torneo</button>
                <button id="backToPlayerInputButton" class="btn btn-secondary">Volver</button>
            </div>
            <p class="copyright-text">Derechos reservados &reg; - EM. 9995.86.68.81.</p>
        </div>

        <!-- Match Screen -->
        <div id="matchScreen" class="screen">
            <div class="screen-content">
                <h2 id="matchTitle" style="display: flex; align-items: center; justify-content: space-between; font-size: 1.75rem; margin-bottom: 1rem;">
                    <span style="flex-grow: 1; text-align: left;"><b>Match:</b> <span id="currentMatchTeams"></span></span>
                    <span id="matchTimerDisplay" style="font-size: 1.4rem; font-weight: bold; color: #1f2937;">00:00</span>
                </h2>
                <div class="match-scoreboard">
                    <p class="text-lg font-semibold mb-2">Sets de juego:</p>
                    <select id="setsToPlay" class="mb-4">
                        <option value="1">1 Set</option>
                        <option value="3" selected>3 Sets</option>
                        <option value="5">5 Sets</option>
                    </select>
                    <div class="flex justify-center"> <!-- Changed to flex container for centering -->
                        <button id="startMatchButton" class="btn mb-4">Iniciar Juego</button>
                    </div>

                    <div class="match-teams">
                        <!-- Contenedor para Equipo 1: número y nombre -->
                        <div class="team-name-box-container">
                            <span class="team-number-label" id="team1NumberLabel"></span>
                            <div id="team1NameDisplay" class="team-name-display">
                                <!-- El contenido se llenará con JS -->
                            </div>
                        </div>
                        <span>vs</span>
                        <!-- Contenedor para Equipo 2: número y nombre -->
                        <div class="team-name-box-container">
                            <span class="team-number-label" id="team2NumberLabel"></span>
                            <div id="team2NameDisplay" class="team-name-display">
                                <!-- El contenido se llenará con JS -->
                            </div>
                        </div>
                    </div>

                    <div class="score-display">
                        <div class="score-item points-separator"> <!-- Added class for separator -->
                            <span class="score-label">Puntos</span>
                            <span id="scoreTeam1Points">0</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">Sets</span>
                            <span id="scoreTeam1Sets">0</span>
                        </div>
                        <span class="text-5xl mx-4">-</span>
                        <div class="score-item points-separator"> <!-- Added class for separator -->
                            <span class="score-label">Puntos</span>
                            <span id="scoreTeam2Points">0</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">Sets</span>
                            <span id="scoreTeam2Sets">0</span>
                        </div>
                    </div>

                    <div class="score-buttons">
                        <button id="addPointTeam1" class="score-btn">Punto</button>
                        <button id="addPointTeam2" class="score-btn">Punto</button>
                    </div>
                </div>
                <!-- Botones en la parte inferior de la pantalla de partido -->
                <button id="resetScoreButton" class="btn btn-secondary mt-4">Resetear Puntaje</button>
                <button id="generateMatchSummaryButton" class="btn mt-2">Ver Duración del Partido ⏱️</button> <!-- Changed text and added emoji -->
                <button id="viewTournamentSummaryButton" class="btn mt-2">Ver Resumen del Torneo</button>
                <button id="backToTournamentDisplayButton" class="btn btn-secondary mt-2">Volver a Duplas</button>
            </div>
            <p class="copyright-text">Derechos reservados &reg; - EM. 9995.86.68.81.</p>
        </div>

        <!-- Tournament Progress Screen (New) -->
        <div id="tournamentProgressScreen" class="screen">
            <div class="screen-content">
                <h2>Progreso del Torneo</h2>
                <div id="tournamentMatchesSummary" class="tournament-progress">
                    <!-- Summary of played matches and winners -->
                </div>
                <button id="returnToMatchButton" class="btn mt-4">Volver a Marcadores</button>
                <button id="startNextRoundButton" class="btn mt-2">Siguiente Ronda</button>
                <button id="analyzeNextRoundButton" class="btn mt-2">Analizar Siguiente Ronda ✨</button> <!-- New Gemini button -->
                <button id="backToMainFromProgress" class="btn btn-secondary mt-2">Volver al Inicio</button>
            </div>
            <p class="copyright-text">Derechos reservados &reg; - EM. 9995.86.68.81.</p>
        </div>

        <!-- Instructions Screen (New) -->
        <div id="instructionsScreen" class="screen">
            <div class="screen-content">
                <h2>Instrucciones del Torneo</h2>
                <div class="text-left">
                    <h3 class="text-lg font-semibold mb-2">Paso a Paso:</h3>
                    <ol class="list-decimal list-inside space-y-2 text-gray-700">
                        <li><b>Iniciar la App:</b> Abre "Padel Time v.1" y haz clic en "Iniciar".</li>
                        <li><b>Seleccionar Modalidad:</b> Elige "Torneo" para empezar. ("Juegos ganados" está en desarrollo).</li>
                        <li><b>Ingresar Jugadores:</b> En la pantalla "Ingresa los detalles", escribe un nombre por línea para cada jugador. Necesitas al menos 4 jugadores y un número par.</li>
                        <li><b>Generar Duplas:</b> Haz clic en "Generar Duplas". La app mezclará los nombres y formará las parejas aleatoriamente.</li>
                        <li><b>Iniciar Torneo:</b> En la pantalla "Duplas del Torneo", haz clic en "Iniciar Torneo". Esto cargará el primer partido.</li>
                        <li><b>Configurar Sets:</b> En la pantalla del partido, selecciona el número de sets a jugar (1, 3 o 5).</li>
                        <li><b>Iniciar Juego:</b> Haz clic en "Iniciar Juego". El cronómetro comenzará a correr.</li>
                        <li><b>Anotar Puntos:</b> Usa los botones "Punto" para sumar puntos a cada equipo (0, 15, 30, 40). Al ganar 4 puntos, se suma 1 Set.</li>
                        <li><b>Fin del Partido:</b> Cuando un equipo gane la cantidad de sets requerida, el partido finalizará, el cronómetro se detendrá y se registrará el ganador.</li>
                        <li><b>Siguiente Partido:</b> El botón "Iniciar Juego" cambiará a "Siguiente Partido". Haz clic para cargar el siguiente encuentro de la ronda.</li>
                        <li><b>Ver Resumen:</b> En cualquier momento, puedes hacer clic en "Ver Resumen del Torneo" para ver los resultados de los partidos completados.</li>
                        <li><b>Siguiente Ronda:</b> Una vez finalizados todos los partidos de una ronda, el botón "Siguiente Ronda" se activará en el resumen. Al hacer clic, se generarán los nuevos emparejamientos (incluyendo "lucky loser" si aplica) y pasarás a la siguiente fase.</li>
                        <li><b>Resetear:</b> El botón "Resetear Puntaje" reiniciará el partido actual.</li>
                    </ol>
                </div>
                <button id="backFromInstructionsButton" class="btn mt-4">Volver</button>
            </div>
            <p class="copyright-text">Derechos reservados &reg; - EM. 9995.86.68.81.</p>
        </div>

        <!-- Custom Modal for messages -->
        <div id="customModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeModalButton">&times;</span>
                <p id="modalMessage"></p>
                <div id="loadingIndicator" class="text-gray-500 text-sm mt-2" style="display:none;">Cargando...</div>
                <button id="modalOkButton" class="btn mt-4">OK</button>
            </div>
        </div>

    </div>

    <script>
        // Get references to DOM elements
        const splashScreen = document.getElementById('splashScreen');
        const modeSelectionScreen = document.getElementById('modeSelectionScreen');
        const playerInputScreen = document.getElementById('playerInputScreen');
        const tournamentDisplayScreen = document.getElementById('tournamentDisplayScreen');
        const matchScreen = document.getElementById('matchScreen'); 
        const tournamentProgressScreen = document.getElementById('tournamentProgressScreen'); 
        const instructionsScreen = document.getElementById('instructionsScreen'); // New instructions screen
        const mainBackground = document.getElementById('mainBackground'); // Reference to the new background div

        const startButton = document.getElementById('startButton');
        const tournamentButton = document.getElementById('tournamentButton');
        const gamesWonButton = document.getElementById('gamesWonButton');
        const exitButton = document.getElementById('exitButton');
        const instructionsButton = document.getElementById('instructionsButton'); // New instructions button
        const generateTeamsButton = document.getElementById('generateTeamsButton');
        const backToModesButton = document.getElementById('backToModesButton');
        const backToPlayerInputButton = document.getElementById('backToPlayerInputButton');
        const startTournamentButton = document.getElementById('startTournamentButton');
        const startMatchButton = document.getElementById('startMatchButton'); 
        const backToTournamentDisplayButton = document.getElementById('backToTournamentDisplayButton'); 
        const startNextRoundButton = document.getElementById('startNextRoundButton'); 
        const backToMainFromProgress = document.getElementById('backToMainFromProgress'); 
        const viewTournamentSummaryButton = document.getElementById('viewTournamentSummaryButton'); 
        const returnToMatchButton = document.getElementById('returnToMatchButton'); 
        const backFromInstructionsButton = document.getElementById('backFromInstructionsButton'); // New back button for instructions

        const playerNamesTextarea = document.getElementById('playerNames');
        const playerCountDisplay = document.getElementById('playerCount');
        const playerInputError = document.getElementById('playerInputError');
        const teamDisplay = document.getElementById('teamDisplay');
        const tournamentMatchesSummary = document.getElementById('tournamentMatchesSummary'); 

        const matchTitle = document.getElementById('matchTitle');
        const setsToPlaySelect = document.getElementById('setsToPlay'); 
        
        // References to the new elements to display team name and number
        const team1NumberLabel = document.getElementById('team1NumberLabel');
        const team1NameDisplay = document.getElementById('team1NameDisplay');
        const team2NumberLabel = document.getElementById('team2NumberLabel');
        const team2NameDisplay = document.getElementById('team2NameDisplay');

        const scoreTeam1Points = document.getElementById('scoreTeam1Points');
        const scoreTeam1Sets = document.getElementById('scoreTeam1Sets');
        const scoreTeam2Points = document.getElementById('scoreTeam2Points');
        const scoreTeam2Sets = document.getElementById('scoreTeam2Sets');
        const addPointTeam1Btn = document.getElementById('addPointTeam1');
        const addPointTeam2Btn = document.getElementById('addPointTeam2'); 
        const resetScoreButton = document.getElementById('resetScoreButton'); 
        const generateMatchSummaryButton = document.getElementById('generateMatchSummaryButton'); // New button
        const analyzeNextRoundButton = document.getElementById('analyzeNextRoundButton'); // New button


        const customModal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const closeModalButton = document.getElementById('closeModalButton');
        const modalOkButton = document.getElementById('modalOkButton');
        const loadingIndicator = document.getElementById('loadingIndicator'); // Loading indicator

        const matchTimerDisplay = document.getElementById('matchTimerDisplay'); // Timer display element
        let timerInterval; // Variable to hold the setInterval ID

        let currentMode = ''; 
        let allDuplas = []; 
        let tournamentRounds = []; // Stores arrays of matches for each round
        let currentRoundIndex = 0; // Index of the current round being played
        let currentMatchIndex = 0; // Index of the current match within the current round

        let currentMatch = {
            team1: null,
            team2: null,
            score: {
                points: [0, 0], 
                sets: [0, 0]   
            },
            setsRequired: 3, 
            winner: null, 
            isCompleted: false,
            startTime: null, // New property for match start time
            endTime: null    // New property for match end time
        };

        // Mapping to display Padel points (0, 15, 30, 40)
        const padelPoints = [0, 15, 30, 40]; 

        // Function to show a specific screen and hide others
        function showScreen(screenId) {
            const screens = [splashScreen, modeSelectionScreen, playerInputScreen, tournamentDisplayScreen, matchScreen, tournamentProgressScreen, instructionsScreen]; // Added instructionsScreen
            screens.forEach(screen => {
                if (screen.id === screenId) {
                    screen.classList.add('active');
                } else {
                    screen.classList.remove('active');
                }
            });

            // Control visibility of the main background
            if (screenId === 'splashScreen') {
                mainBackground.classList.remove('active-bg');
            } else {
                mainBackground.classList.add('active-bg');
            }
        }

        // Function to show the custom modal with a message
        function showModal(message) {
            modalMessage.innerHTML = message; // Use innerHTML to allow HTML formatting in the message
            customModal.style.display = 'flex';
        }

        // Function to hide the custom modal
        function hideModal() {
            customModal.style.display = 'none';
        }

        // Function to update the scoreboard display
        function updateScoreboard() {
            scoreTeam1Points.textContent = padelPoints[currentMatch.score.points[0]];
            scoreTeam2Points.textContent = padelPoints[currentMatch.score.points[1]];
            scoreTeam1Sets.textContent = currentMatch.score.sets[0];
            scoreTeam2Sets.textContent = currentMatch.score.sets[1];
        }

        // Function to handle adding a point to a team (Simplified Padel logic)
        function addPoint(teamIndex) {
            // FIX: Prevent scoring if match hasn't started
            if (!currentMatch.startTime) {
                showModal('Debes iniciar el juego antes de sumar puntos.');
                return;
            }
            if (currentMatch.isCompleted) {
                showModal('El partido ha terminado. Por favor, inicia el siguiente partido o resetea el puntaje.');
                return;
            }

            // Incrementar el contador de puntos interno (0, 1, 2, 3)
            currentMatch.score.points[teamIndex]++;

            // If the team reaches 4 points (equivalente a ganar el set en esta lógica simplificada)
            if (currentMatch.score.points[teamIndex] >= 4) {
                winSet(teamIndex);
            }
            updateScoreboard();
        }

        // Function to handle winning a set
        function winSet(teamIndex) {
            currentMatch.score.sets[teamIndex]++;
            const winnerTeamName = teamIndex === 0 ?
                `${currentMatch.team1[0]} & ${currentMatch.team1[1]}` :
                `${currentMatch.team2[0]} & ${currentMatch.team2[1]}`;
            showModal(`${winnerTeamName} (Equipo ${teamIndex + 1}) gana el set!`);
            
            // Reset points for both teams for the new set
            currentMatch.score.points = [0, 0]; 
            updateScoreboard(); 
            
            checkMatchWin(teamIndex);
        }

        // Function to check for match win
        function checkMatchWin(winningTeamIndex) {
            const setsNeededToWin = Math.ceil(currentMatch.setsRequired / 2);
            if (currentMatch.score.sets[winningTeamIndex] >= setsNeededToWin) {
                const winnerTeam = winningTeamIndex === 0 ? currentMatch.team1 : currentMatch.team2;
                const loserTeam = winningTeamIndex === 0 ? currentMatch.team2 : currentMatch.team1; // Get the losing team
                const winnerTeamName = `${winnerTeam[0]} & ${winnerTeam[1]}`;
                showModal(`¡El partido ha terminado! ${winnerTeamName} (Equipo ${winningTeamIndex + 1}) gana el partido!`);
                
                // Record end time and stop timer
                currentMatch.endTime = new Date();
                clearInterval(timerInterval); // Stop the timer

                // Update the match in the tournament list with the winner and final score
                tournamentRounds[currentRoundIndex][currentMatchIndex].winner = winnerTeam;
                tournamentRounds[currentRoundIndex][currentMatchIndex].status = 'completed';
                tournamentRounds[currentRoundIndex][currentMatchIndex].finalScore = [...currentMatch.score.sets]; // Store a copy of sets
                tournamentRounds[currentRoundIndex][currentMatchIndex].duration = currentMatch.endTime.getTime() - currentMatch.startTime.getTime(); // Store duration
                currentMatch.isCompleted = true; // Mark current match as completed

                addPointTeam1Btn.disabled = true; // Disable scoring buttons
                addPointTeam2Btn.disabled = true;
                
                // Change "Start Game" button text to "Next Match"
                startMatchButton.textContent = 'Siguiente Partido';
                startMatchButton.disabled = false; // Enable button for next match
                generateMatchSummaryButton.style.display = 'inline-block'; // Show summary button
                
                updateTournamentSummary(); // Update tournament summary
            }
        }

        // Function to reset all scores for the current match
        function resetAllScores() {
            currentMatch.score = {
                points: [0, 0],
                sets: [0, 0]
            };
            currentMatch.isCompleted = false; // Match is no longer completed
            currentMatch.startTime = null; // Reset start time
            currentMatch.endTime = null; // Reset end time
            clearInterval(timerInterval); // Clear timer interval
            matchTimerDisplay.textContent = "00:00"; // Reset timer display
            updateScoreboard();
            // FIX: Scoring buttons should be disabled on reset, until game starts
            addPointTeam1Btn.disabled = true; 
            addPointTeam2Btn.disabled = true;
            startMatchButton.textContent = 'Iniciar Juego'; // Reset button text
            startMatchButton.disabled = false; // Ensure start button is enabled
            generateMatchSummaryButton.style.display = 'none'; // Hide summary button
            showModal('Puntaje reseteado.');
        }

        // Function to generate matches for the first round of the tournament
        function generateFirstRoundMatches(duplas) {
            tournamentRounds = []; // Reset all rounds
            const firstRoundMatches = [];
            for (let i = 0; i < duplas.length; i += 2) {
                if (duplas[i + 1]) { // Ensure there is a second team
                    firstRoundMatches.push({
                        team1: duplas[i],
                        team2: duplas[i + 1],
                        winner: null,
                        status: 'pending',
                        finalScore: null, // Store final score of sets [team1_sets, team2_sets]
                        duration: null // Store match duration
                    });
                } else {
                    // Handle bye
                    firstRoundMatches.push({
                        team1: duplas[i],
                        team2: null, // Indicates a bye
                        winner: duplas[i], // Team with bye automatically wins this "match"
                        status: 'completed',
                        finalScore: [1, 0], // A bye is like winning 1-0 in sets
                        duration: 0 // No duration for bye
                    });
                    showModal(`Advertencia: Hay un número impar de duplas. ${duplas[i][0]} & ${duplas[i][1]} tiene un "bye" en esta ronda.`);
                }
            }
            tournamentRounds.push(firstRoundMatches); // Add the first round
            currentRoundIndex = 0; // Start at the first round
            currentMatchIndex = -1; // Prepare for loadNextMatch
        }

        // Function to update the timer display
        function updateTimer() {
            if (currentMatch.startTime) {
                const now = new Date();
                const elapsedMs = now.getTime() - currentMatch.startTime.getTime();
                const minutes = Math.floor(elapsedMs / (1000 * 60));
                const seconds = Math.floor((elapsedMs % (1000 * 60)) / 1000);
                const formattedMinutes = String(minutes).padStart(2, '0');
                const formattedSeconds = String(seconds).padStart(2, '0');
                matchTimerDisplay.textContent = `${formattedMinutes}:${formattedSeconds}`;
            }
        }

        // Function to load the next match
        function loadNextMatch() {
            currentMatchIndex++;
            // Check if there are more matches in the current round
            if (currentMatchIndex < tournamentRounds[currentRoundIndex].length) {
                const nextMatch = tournamentRounds[currentRoundIndex][currentMatchIndex];

                // If this match is already completed (e.g., a bye), skip to the next one
                if (nextMatch.status === 'completed') {
                    loadNextMatch();
                    return;
                }

                currentMatch.team1 = nextMatch.team1;
                currentMatch.team2 = nextMatch.team2;
                currentMatch.isCompleted = false; // Reset state for the new match
                currentMatch.winner = null; // Reset winner for the new match
                currentMatch.startTime = null; // Reset start time for new match
                currentMatch.endTime = null; // Reset end time for new match
                clearInterval(timerInterval); // Clear any running timer
                matchTimerDisplay.textContent = "00:00"; // Reset timer display


                // Update matchTitle to include the current match teams
                const teamNamesForTitle = currentMatch.team2 ? 
                    `${currentMatch.team1[0]} & ${currentMatch.team1[1]} vs ${currentMatch.team2[0]} & ${currentMatch.team2[1]}` : 
                    `${currentMatch.team1[0]} & ${currentMatch.team1[1]} vs BYE`;
                document.getElementById('currentMatchTeams').textContent = teamNamesForTitle; // Update only the span content
                
                team1NumberLabel.textContent = `Equipo 1`;
                team1NameDisplay.innerHTML = `🎾 ${currentMatch.team1[0]} & ${currentMatch.team1[1]}`;
                
                team2NumberLabel.textContent = `Equipo 2`;
                team2NameDisplay.innerHTML = currentMatch.team2 ? `🎾 ${currentMatch.team2[0]} & ${currentMatch.team2[1]}` : 'BYE';

                resetAllScores(); // Reset the scoreboard for the new match
                startMatchButton.textContent = 'Iniciar Juego'; // Reset button text
                startMatchButton.disabled = false; // Enable start button
                generateMatchSummaryButton.style.display = 'none'; // Hide summary button when loading new match

                // Enhanced modal message for next match
                const nextMatchMessage = `
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">¡Próximo Partido! 🚀</h3>
                    <p class="text-lg font-medium text-indigo-700">${currentMatch.team1[0]} & ${currentMatch.team1[1]}</p>
                    <p class="text-base font-semibold text-gray-600" style="font-size: 0.9em;">VS</p>
                    <p class="text-lg font-medium text-indigo-700">${currentMatch.team2 ? currentMatch.team2[0] + ' & ' + currentMatch.team2[1] : 'BYE'}</p>
                    <p class="text-sm mt-2 text-gray-500">¡Que comience el juego!</p>
                `;
                showModal(nextMatchMessage);

            } else {
                // All matches in the current round have been played
                showModal('¡Todos los partidos de esta ronda han sido jugados! Puedes ver el progreso del torneo y generar la siguiente ronda.');
                startMatchButton.disabled = true;
                startMatchButton.textContent = 'Ronda Finalizada';
                showScreen('tournamentProgressScreen'); // Go to tournament progress screen
                updateTournamentSummary(); // Ensure summary is updated
                startNextRoundButton.disabled = false; // Enable the "Next Round" button
            }
        }

        // Function to update the tournament summary
        function updateTournamentSummary() {
            tournamentMatchesSummary.innerHTML = ''; // Clear previous content
            tournamentRounds.forEach((roundMatches, roundNum) => {
                tournamentMatchesSummary.innerHTML += `<h3 class="text-lg font-semibold mb-2">Ronda ${roundNum + 1}:</h3>`;
                roundMatches.forEach((match, index) => {
                    const team1Display = `${match.team1[0]} & ${match.team1[1]}`;
                    const team2Display = match.team2 ? `${match.team2[0]} & ${match.team2[1]}` : 'BYE';
                    let winnerDisplay = '';
                    let matchItemClass = 'match-summary-item';
                    let winnerBoxClass = 'winner-box-summary';
                    let winnerEmoji = '🏆'; // Default winner emoji

                    if (match.status === 'completed') {
                        winnerDisplay = `${match.winner[0]} & ${match.winner[1]}`;
                        // Check if it's the final round and this is the last match
                        if (roundNum === tournamentRounds.length - 1 && roundMatches.length === 1) { // Final round has only one match
                            winnerEmoji = '🏆👑'; // Champion emojis
                            winnerBoxClass += ' winner-box-champion'; // Apply champion specific style
                        }
                    } else {
                        winnerDisplay = 'Pendiente';
                        matchItemClass += ' pending';
                        winnerBoxClass += ' pending-winner';
                    }

                    tournamentMatchesSummary.innerHTML += `
                        <div class="${matchItemClass}">
                            <div class="match-teams-summary">
                                <div class="team-box-summary">🎾 ${team1Display}</div>
                                <span class="vs-text">vs</span>
                                <div class="team-box-summary">🎾 ${team2Display}</div>
                            </div>
                            <div class="winner-arrow">→</div>
                            <div class="${winnerBoxClass}">${winnerEmoji} ${winnerDisplay}</div>
                        </div>
                    `;
                });
            });
        }

        // --- Gemini API Integration Functions ---

        // Function to make API call with exponential backoff
        async function callGeminiApi(prompt) {
            loadingIndicator.style.display = 'block'; // Show loading indicator
            modalOkButton.disabled = true; // Disable OK button during loading

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // Canvas will automatically provide this in runtime

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let response;
            let retries = 0;
            const maxRetries = 5;
            const baseDelay = 1000; // 1 second

            while (retries < maxRetries) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            return result.candidates[0].content.parts[0].text;
                        } else {
                            throw new Error("Unexpected API response structure.");
                        }
                    } else {
                        // Handle non-OK responses, potentially retry
                        const errorData = await response.json();
                        console.error("API error:", response.status, errorData);
                        if (response.status === 429 || response.status >= 500) { // Too Many Requests or Server Error
                            retries++;
                            const delay = baseDelay * Math.pow(2, retries);
                            await new Promise(res => setTimeout(res, delay));
                        } else {
                            throw new Error(`API returned status ${response.status}: ${errorData.error?.message || 'Unknown error'}`);
                        }
                    }
                } catch (error) {
                    console.error("Fetch error:", error);
                    retries++;
                    const delay = baseDelay * Math.pow(2, retries);
                    await new Promise(res => setTimeout(res, delay));
                }
            }
            throw new Error("Max retries exceeded. Failed to get response from Gemini API.");
        }

        // Function to show match duration
        async function showMatchDuration() {
            if (!currentMatch.startTime || !currentMatch.endTime) {
                showModal('El partido no ha terminado o no se pudo registrar el tiempo.');
                return;
            }

            const durationMs = currentMatch.endTime.getTime() - currentMatch.startTime.getTime();
            const minutes = Math.floor(durationMs / (1000 * 60));
            const seconds = Math.floor((durationMs % (1000 * 60)) / 1000);

            showModal(`<h3>Duración del Partido:</h3><p>${minutes} minutos y ${seconds} segundos.</p>`);
        }

        // Function to analyze next round using Gemini API
        async function analyzeNextRound() {
            startNextRoundButton.disabled = true; // Disable "Next Round" button
            analyzeNextRoundButton.disabled = true; // Disable this button during analysis

            const currentRoundMatches = tournamentRounds[currentRoundIndex];
            const roundWinners = [];
            const roundLosers = [];

            currentRoundMatches.forEach(match => {
                if (match.status === 'completed') {
                    roundWinners.push(match.winner);
                    if (match.team2 !== null) {
                        const loserIndex = (match.winner === match.team1) ? 1 : 0;
                        const losingTeam = (loserIndex === 0) ? match.team1 : match.team2;
                        roundLosers.push({ team: losingTeam, setsWon: match.finalScore[loserIndex] });
                    }
                }
            });

            let prompt = `Analiza la ronda actual de un torneo de pádel y haz una predicción o comentario sobre la siguiente ronda o el torneo en general.
            Ganadores de esta ronda: ${roundWinners.map(t => `${t[0]} & ${t[1]}`).join(', ')}.`;

            if (roundLosers.length > 0) {
                prompt += ` Perdedores de esta ronda (con sets ganados): ${roundLosers.map(l => `${l.team[0]} & ${l.team[1]} (${l.setsWon} sets)`).join(', ')}.`;
            }
            if (roundWinners.length === 3) {
                prompt += ` Un equipo perdedor será seleccionado como "lucky loser" para la semifinal de 4 equipos.`;
            }
            prompt += ` ¿Quiénes crees que tienen más posibilidades de ganar el torneo o qué partidos serán los más interesantes en la siguiente fase? Sé conciso y emocionante. No incluyas saludos ni despedidas.`;

            showModal('Analizando la siguiente ronda...');
            loadingIndicator.style.display = 'block';

            try {
                const analysis = await callGeminiApi(prompt);
                showModal(`<h3>Análisis de la Siguiente Ronda:</h3><p>${analysis}</p>`);
            } catch (error) {
                showModal(`Error al generar el análisis: ${error.message}. Inténtalo de nuevo.`);
            } finally {
                loadingIndicator.style.display = 'none';
                modalOkButton.disabled = false;
                startNextRoundButton.disabled = false; // Re-enable "Next Round" button
                analyzeNextRoundButton.disabled = false; // Re-enable this button
            }
        }


        // Event Listeners
        startButton.addEventListener('click', () => {
            showScreen('modeSelectionScreen');
        });

        tournamentButton.addEventListener('click', () => {
            currentMode = 'Torneo';
            showScreen('playerInputScreen');
        });

        gamesWonButton.addEventListener('click', () => {
            currentMode = 'Juegos ganados';
            showModal('La modalidad "Juegos ganados" aún no está implementada. Por favor, selecciona "Torneo".');
        });

        exitButton.addEventListener('click', () => {
            showScreen('splashScreen'); // Return to splash screen
        });

        backToModesButton.addEventListener('click', () => {
            showScreen('modeSelectionScreen');
        });

        backToPlayerInputButton.addEventListener('click', () => {
            showScreen('playerInputScreen');
        });

        backToTournamentDisplayButton.addEventListener('click', () => {
            showScreen('tournamentDisplayScreen');
            addPointTeam1Btn.disabled = false; 
            addPointTeam2Btn.disabled = false;
        });

        viewTournamentSummaryButton.addEventListener('click', () => { 
            updateTournamentSummary();
            showScreen('tournamentProgressScreen');
        });

        returnToMatchButton.addEventListener('click', () => { 
            showScreen('matchScreen');
        });

        instructionsButton.addEventListener('click', () => { // Event listener for Instructions button
            showScreen('instructionsScreen');
        });
        backFromInstructionsButton.addEventListener('click', () => { // Event listener for back button on instructions screen
            showScreen('modeSelectionScreen');
        });

        playerNamesTextarea.addEventListener('input', () => {
            const players = playerNamesTextarea.value.split('\n').filter(name => name.trim() !== '');
            playerCountDisplay.textContent = `Jugadores ingresados: ${players.length}`;
            playerInputError.textContent = ''; 
        });

        generateTeamsButton.addEventListener('click', () => {
            const players = playerNamesTextarea.value.split('\n').map(name => name.trim()).filter(name => name !== '');

            playerInputError.textContent = ''; 

            if (players.length < 4) {
                playerInputError.textContent = 'Necesitas al menos 4 jugadores para formar duplas.';
                return;
            }
            if (players.length % 2 !== 0) {
                playerInputError.textContent = 'El número de jugadores debe ser par para formar duplas.';
                return;
            }

            // Mezclar jugadores aleatoriamente
            for (let i = players.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [players[i], players[j]] = [players[j], players[i]];
            }

            // Formar todas las duplas posibles a partir de los jugadores mezclados
            allDuplas = []; 
            for (let i = 0; i < players.length; i += 2) {
                allDuplas.push([players[i], players[i + 1]]);
            }

            displayTournamentDuplas(allDuplas);
            showScreen('tournamentDisplayScreen');
        });

        startTournamentButton.addEventListener('click', () => {
            if (allDuplas.length < 2) {
                showModal('Necesitas al menos 2 duplas para iniciar un partido de torneo.');
                return;
            }
            
            generateFirstRoundMatches(allDuplas); 
            currentMatchIndex = -1; // Reset to load the first match
            loadNextMatch(); 
            
            showScreen('matchScreen');
        });

        startMatchButton.addEventListener('click', () => {
            if (currentMatch.isCompleted) { 
                loadNextMatch();
            } else { 
                currentMatch.setsRequired = parseInt(setsToPlaySelect.value, 10);
                showModal(`¡El juego ha iniciado! Se jugarán al mejor de ${currentMatch.setsRequired} sets.`);
                currentMatch.score = {
                    points: [0, 0],
                    sets: [0, 0]
                };
                updateScoreboard();
                // FIX: Enable scoring buttons only when match starts
                addPointTeam1Btn.disabled = false; 
                addPointTeam2Btn.disabled = false;
                startMatchButton.disabled = true; 
                currentMatch.startTime = new Date(); // Start timer when game begins
                // Start updating the timer display
                timerInterval = setInterval(updateTimer, 1000); 
            }
        });

        addPointTeam1Btn.addEventListener('click', () => addPoint(0));
        addPointTeam2Btn.addEventListener('click', () => addPoint(1));
        resetScoreButton.addEventListener('click', resetAllScores); 
        generateMatchSummaryButton.addEventListener('click', showMatchDuration); // Changed to showMatchDuration
        if (analyzeNextRoundButton) {
            analyzeNextRoundButton.addEventListener('click', analyzeNextRound);
        }

        startNextRoundButton.addEventListener('click', () => {
            // Disable the button immediately to prevent multiple clicks
            startNextRoundButton.disabled = true;

            // 1. Get Winners and Losers from the current round
            const currentRoundMatches = tournamentRounds[currentRoundIndex];
            const roundWinners = [];
            const roundLosers = []; // Store objects: { team: [player1, player2], setsLost: number }

            currentRoundMatches.forEach(match => {
                if (match.status === 'completed') {
                    roundWinners.push(match.winner);
                    // Identify the loser and their sets won (if not a bye)
                    if (match.team2 !== null) { // Not a bye
                        const loserIndex = (match.winner === match.team1) ? 1 : 0;
                        const losingTeam = (loserIndex === 0) ? match.team1 : match.team2;
                        const setsWonByLoser = match.finalScore[loserIndex];
                        roundLosers.push({ team: losingTeam, setsWon: setsWonByLoser });
                    }
                }
            });

            // Handle the end of the tournament
            if (roundWinners.length === 1) {
                showModal(`¡El torneo ha terminado! El campeón es: ${roundWinners[0][0]} & ${roundWinners[0][1]}`);
                updateTournamentSummary(); // Update to show champion emoji
                return; // End of tournament
            }

            let nextRoundParticipants = [...roundWinners];

            // 2. Handle "lucky loser" scenario if needed (e.g., 3 winners for a 4-team semifinal)
            if (roundWinners.length === 3) {
                if (roundLosers.length > 0) {
                    // Sort losers by sets won (descending), then pick the first one
                    roundLosers.sort((a, b) => b.setsWon - a.setsWon);
                    const luckyLoser = roundLosers[0].team;
                    nextRoundParticipants.push(luckyLoser);
                    showModal(`¡Un equipo perdedor avanza! El equipo de "lucky loser" es: ${luckyLoser[0]} & ${luckyLoser[1]}`);
                } else {
                    showModal('Advertencia: No hay perdedores disponibles para un "lucky loser". Se necesitará un "bye".');
                    // If no losers, a bye will be implicitly handled in pairing
                }
            }
            
            // Shuffle participants for new pairings
            for (let i = nextRoundParticipants.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [nextRoundParticipants[i], nextRoundParticipants[j]] = [nextRoundParticipants[j], nextRoundParticipants[i]];
            }

            // 3. Generate New Matches
            const newRoundMatches = [];
            for (let i = 0; i < nextRoundParticipants.length; i += 2) {
                if (nextRoundParticipants[i + 1]) {
                    newRoundMatches.push({
                        team1: nextRoundParticipants[i],
                        team2: nextRoundParticipants[i + 1],
                        winner: null,
                        status: 'pending',
                        finalScore: null
                    });
                } else {
                    newRoundMatches.push({
                        team1: nextRoundParticipants[i],
                        team2: null,
                        winner: nextRoundParticipants[i],
                        status: 'completed',
                        finalScore: [1, 0]
                    });
                    showModal(`Advertencia: Un equipo (${nextRoundParticipants[i][0]} & ${nextRoundParticipants[i][1]}) avanza por "bye" en la siguiente ronda.`);
                }
            }

            if (newRoundMatches.length === 0) {
                showModal('No se pudieron generar partidos para la siguiente ronda. El torneo puede haber terminado o no hay suficientes equipos.');
                return;
            }

            // 4. Update Tournament State
            tournamentRounds.push(newRoundMatches); // Add the new round
            currentRoundIndex++; // Move to the next round
            currentMatchIndex = -1; // Prepare to load the first match of the new round

            showModal(`¡Comienza la Ronda ${currentRoundIndex + 1}!`);
            loadNextMatch(); // Load the first match of the new round
            showScreen('matchScreen'); // Go back to the match screen
        });
        backToMainFromProgress.addEventListener('click', () => {
            showScreen('modeSelectionScreen');
        });


        closeModalButton.addEventListener('click', hideModal);
        modalOkButton.addEventListener('click', hideModal);
        window.addEventListener('click', (event) => {
            if (event.target == customModal) {
                hideModal();
            }
        });

        // Function to display all formed duplas for tournament mode
        function displayTournamentDuplas(duplas) {
            teamDisplay.innerHTML = ''; 
            let teamCounter = 1;

            if (duplas.length === 0) {
                teamDisplay.innerHTML = '<p class="text-gray-500">No se pudieron formar duplas con los jugadores ingresados.</p>';
                return;
            }

            // Create match-ups (e.g., Team 1 vs Team 2)
            for (let i = 0; i < duplas.length; i += 2) {
                const team1 = duplas[i];
                const team2 = duplas[i + 1]; 

                const matchCardDiv = document.createElement('div');
                matchCardDiv.classList.add('match-card');

                if (team2) { 
                    matchCardDiv.innerHTML = `
                        <div class="match-line">
                            <div class="team-name-display">🎾 Equipo ${teamCounter++}: ${team1[0]} & ${team1[1]}</div>
                        </div>
                        <div class="match-line">
                            <span class="vs-text-display">VS</span>
                        </div>
                        <div class="match-line">
                            <div class="team-name-display">🎾 Equipo ${teamCounter++}: ${team2[0]} & ${team2[1]}</div>
                        </div>
                    `;
                } else { 
                    matchCardDiv.innerHTML = `
                        <div class="match-line">
                            <div class="team-name-display">🎾 Equipo ${teamCounter++}: ${team1[0]} & ${team1[1]}</div>
                        </div>
                        <div class="match-line">
                            <span class="vs-text-display">BYE</span>
                        </div>
                        <div class="match-line">
                            <div class="team-name-display pending-winner">Esperando oponente...</div>
                        </div>
                    `;
                }
                teamDisplay.appendChild(matchCardDiv);
            }
        }

        // Initial screen setup
        showScreen('splashScreen');
    </script>
</body>
</html>
